<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Ancestry Test Results</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="text-center mt-5">
            <h1>Ancestry Test Results</h1>
            <p class="lead">Sample ID: {{ results.sample_id }}</p>
        </header>

        <section id="results-section" class="mt-4">
            {% if results and not results.error_message %}
                <div class="row">
                    <div class="col-md-6">
                        <h3>Estimated Ancestry Distribution</h3>
                        {% if results.display_predictions %}
                            <table class="table table-hover table-sm">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Ancestry Population</th>
                                        <th>Estimated Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in results.display_predictions %}
                                    <tr>
                                        <td>{{ item.category }}</td>
                                        <td>{{ item.percentage_str }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% if results.dominant_ancestry and results.dominant_ancestry != "N/A" %}
                                <div class="mt-3 alert alert-info">
                                    <strong>Dominant Ancestry:</strong> {{ results.dominant_ancestry }}
                                    {% if results.dominant_percentage_str and results.dominant_percentage_str != "N/A" %}
                                        ({{ results.dominant_percentage_str }})
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No detailed predictions to display.</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h3>Visual Distribution</h3>
                        <div class="chart-container">
                            <canvas id="ethnicityPieChart"></canvas>
                        </div>
                    </div>
                </div>
            {% elif results.error_message %}
                <div class="alert alert-danger" role="alert">
                    <h4>An Error Occurred!</h4>
                    <p>{{ results.error_message }}</p>
                    <p>Please return to the main page and try again, or check your file.</p>
                </div>
            {% else %}
                 <div class="alert alert-warning" role="alert">
                    Could not load results or an issue occurred.
                </div>
            {% endif %}

            <div class="text-center mt-4">
                <a href="{{ url_for('index') }}" class="btn btn-secondary">New Estimation</a>
            </div>
        </section>

        <footer class="text-center mt-5 mb-3">
            <p class="text-muted">&copy; 2024-2025 Ancestry Estimator</p>
        </footer>
    </div>

    {% if results and not results.error_message and results.labels and results.percentages %}
    <script>
        const ctx = document.getElementById('ethnicityPieChart').getContext('2d');

        const professionalColors = [
            '#0d6efd', '#6c757d', '#198754', '#dc3545', '#ffc107', '#0dcaf0', '#212529',
            '#0b5ed7', '#5c636a', '#157347', '#bb2d3b', '#eea200', '#0aa3c2',
            '#4d8bf9', '#868e96', '#48a474'
        ];

        const chartColors = professionalColors.slice(0, {{ results.labels|length }});

        const ethnicityData = {
            labels: {{ results.labels|tojson }},
            datasets: [{
                label: 'Ancestry Distribution',
                data: {{ results.percentages|tojson }},
                backgroundColor: chartColors,
                borderColor: '#ffffff',
                borderWidth: 2,
                hoverOffset: 4
            }]
        };

        const config = {
            type: 'pie',
            data: ethnicityData,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                family: 'Times New Roman',
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        };
        const ethnicityPieChart = new Chart(ctx, config);
    </script>
    {% endif %}
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>